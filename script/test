#! /usr/bin/env bash

set -e

source script/env "$@"

# unless the --coverage or -c or --cov flag is passed, skip coverage and only run `cargo test`
if [[ "$1" != "--coverage" && "$1" != "-c" && "$1" != "--cov" ]]; then
  cargo test --frozen
  exit $?
fi

# Create coverage directory if it doesn't exist
mkdir -p "$DIR/coverage"

# Coverage mode requires preinstalled tools (no network installs).
if ! command -v cargo-llvm-cov >/dev/null 2>&1; then
  echo "cargo-llvm-cov is required for coverage runs." >&2
  echo "Install it with: cargo install cargo-llvm-cov" >&2
  exit 1
fi

if command -v rustup >/dev/null 2>&1; then
  if ! rustup component list --installed | grep -qx "llvm-tools-preview"; then
    echo "rustup component llvm-tools-preview is required for coverage runs." >&2
    echo "Install it with: rustup component add llvm-tools-preview" >&2
    exit 1
  fi
fi

# run coverage
echo -e "\nüß™ ${BLUE}Running coverage: $(date "+%H:%M:%S")${OFF}\n"

cov_exit=0
lcov_path="$DIR/coverage/lcov.info"
html_dir="$DIR/coverage/html"

rm -f "$lcov_path"
rm -rf "$html_dir"

cargo llvm-cov --workspace --all-features \
  --lcov --output-path "$lcov_path" \
  --html --output-dir "$html_dir" \
  --ignore-filename-regex '(^|/)(tests|benches|target|vendor)/|/\.cargo/registry/|/rustc/' \
  && cov_exit=$? || cov_exit=$?

if [[ -f "$lcov_path" ]]; then
  lines_total=$(awk -F: '/^LF:/ {sum += $2} END {print sum+0}' "$lcov_path")
  lines_hit=$(awk -F: '/^LH:/ {sum += $2} END {print sum+0}' "$lcov_path")
  if [[ "$lines_total" -gt 0 ]]; then
    coverage_value=$(awk -v hit="$lines_hit" -v total="$lines_total" 'BEGIN {printf "%.1f", (hit/total)*100}')
    formatted_coverage="${coverage_value}%"
    echo "$formatted_coverage" > "$DIR/coverage/total-coverage.txt"
    if awk -v value="$coverage_value" 'BEGIN {exit !(value >= 100.0)}'; then
      cov_exit=0
      echo -e "\n‚úÖ Total Coverage: ${GREEN}$formatted_coverage${OFF}"
    else
      cov_exit=1
      echo -e "\n‚ùå ${RED}Total Coverage: $formatted_coverage (must be 100%)${OFF}"
    fi
  else
    cov_exit=1
    echo -e "\n‚ùå ${RED}Coverage report missing line counts${OFF}"
  fi
else
  cov_exit=1
  echo -e "\n‚ùå ${RED}Coverage report not found!${OFF}"
fi

[ $cov_exit -gt 0 ] && exit 1
exit 0
