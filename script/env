#! /usr/bin/env bash

set -e # prevent any kind of script failures

# COLORS
export OFF='\033[0m'
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export BLUE='\033[0;34m'
export PURPLE='\033[0;35m'

# Default to air-gapped cargo/rustup behavior.
export CARGO_NET_OFFLINE=true
export RUSTUP_OFFLINE=1

# set RUST_ENV to development (as a default) if not set
: "${RUST_ENV:=development}"

export RUST_ENV

# set the working directory to the root of the project
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"
export DIR

# The name of the repository is the name of the directory (usually)
REPO_NAME=$(basename "$PWD")
export REPO_NAME

TARBALL_DIR="$DIR/tarballs"
export TARBALL_DIR

# set the rust version to the one specified from the rustc --version command
RUST_VERSION=$(rustc --version | cut -d ' ' -f2)
export RUST_VERSION

# detect OS version and architecture
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    PLATFORM="linux"
    VERSION=$(grep '^VERSION_CODENAME=' /etc/os-release | cut -d '=' -f2 || echo "unknown")
elif [[ "$OSTYPE" == "darwin"* ]]; then
    PLATFORM="macos"
    VERSION=$(sw_vers -productVersion || echo "unknown")
else
    PLATFORM="unknown"
    VERSION="unknown"
fi

ARCH=$(uname -m || echo "unknown")

export PLATFORM
export VERSION
export ARCH

VENDOR_DIR="$DIR/vendor/cache"
export VENDOR_DIR

# make the vendor/cache directory if it doesn't exist
mkdir -p "$VENDOR_DIR"

die() {
  echo -e "${RED}error:${OFF} $*" >&2
  exit 1
}

warn() {
  echo -e "${RED}warning:${OFF} $*" >&2
}

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    die "missing required tool: $cmd"
  fi
}

read_version_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    head -n1 "$file" | tr -d '[:space:]'
  fi
}

rust_toolchain_version() {
  sed -n 's/^channel[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/p' "$DIR/rust-toolchain.toml" | head -n1
}

ensure_rust_toolchain() {
  local expected
  expected="$(rust_toolchain_version)"
  if [[ -n "$expected" && "$RUST_VERSION" != "$expected" ]]; then
    die "rust toolchain mismatch (expected ${expected}, found ${RUST_VERSION})"
  fi
  if [[ -f "$DIR/.rust-version" && -n "$expected" ]]; then
    local file_version
    file_version="$(read_version_file "$DIR/.rust-version")"
    if [[ -n "$file_version" && "$file_version" != "$expected" ]]; then
      die ".rust-version mismatch (expected ${expected}, found ${file_version})"
    fi
  fi
}

ensure_vendor_cache() {
  if [[ ! -f "$DIR/.cargo/config.toml" ]]; then
    die "missing .cargo/config.toml; vendored sources are required"
  fi

  if [[ ! -d "$VENDOR_DIR" || -z "$(ls -A "$VENDOR_DIR" 2>/dev/null)" ]]; then
    die "vendor cache is empty; run script/update while online to vendor dependencies"
  fi
}

require_clean_git() {
  if [[ "${CI:-}" == "true" ]]; then
    git diff --exit-code
    git diff --cached --exit-code
  fi
}
